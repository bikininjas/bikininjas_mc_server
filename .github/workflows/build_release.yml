name: Build, Auto-Merge PR, and Release
on:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
  push:
    branches:
      - 'master'
  workflow_dispatch:

jobs:
  # This job runs on PR events to build and test the Docker image
  build-and-test:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout
        uses: actions/checkout@v4.1.7
        
      - name: Docker Setup Buildx
        uses: docker/setup-buildx-action@v3.3.0
        
      - name: Build Docker image (no push)
        uses: docker/build-push-action@v6.2.0
        with:
          push: false
          context: .
          tags: bikininjas/minecraft-server:test
          load: true
          
      - name: Install test dependencies
        run: |
          pip install mcstatus
          
      - name: Run Docker image tests
        run: |
          chmod +x tests/docker/test_docker_build.sh
          cd tests/docker
          ./test_docker_build.sh
          cd ../..
          
      - name: Run basic server tests
        run: |
          chmod +x tests/server/test_server_connection.sh
          cd tests/server
          ./test_server_connection.sh
          cd ../..
          
      - name: Auto-merge if build successful
        if: success()
        uses: pascalgn/automerge-action@v0.15.6
        env:
          GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
          MERGE_LABELS: ""
          MERGE_METHOD: "squash"
          MERGE_COMMIT_MESSAGE: "Auto-merge PR #${{ github.event.pull_request.number }} after successful build"
          MERGE_FORKS: "true"
          MERGE_RETRIES: "6"
          MERGE_RETRY_SLEEP: "10000"
          MERGE_REQUIRED_APPROVALS: "0"

  # This job runs on master branch pushes to build and test the Docker image
  build-and-test-master:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    steps:
      - name: Checkout
        uses: actions/checkout@v4.1.7
        
      - name: Docker Setup Buildx
        uses: docker/setup-buildx-action@v3.3.0
        
      - name: Build Docker image (no push)
        uses: docker/build-push-action@v6.2.0
        with:
          push: false
          context: .
          tags: bikininjas/minecraft-server:test
          load: true
          
      - name: Install test dependencies
        run: |
          pip install mcstatus
          
      - name: Run Docker image tests
        run: |
          chmod +x tests/docker/test_docker_build.sh
          cd tests/docker
          ./test_docker_build.sh
          cd ../..
          
      - name: Run basic server tests
        run: |
          chmod +x tests/server/test_server_connection.sh
          cd tests/server
          ./test_server_connection.sh
          cd ../..

  # This job runs only on pushes to master (including merged PRs) after tests pass
  tag-and-release:
    runs-on: ubuntu-latest
    needs: build-and-test-master
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    steps:
      - name: Checkout
        uses: actions/checkout@v4.1.7
        with:
          fetch-depth: 0
      
      - name: Create Semantic Version Tag
        id: tag_version
        uses: mathieudutour/github-tag-action@v6.2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          default_bump: patch
          release_branches: master
          
      - name: Create GitHub Release
        if: steps.tag_version.outputs.new_tag
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ steps.tag_version.outputs.new_tag }}
          name: Release ${{ steps.tag_version.outputs.new_tag }}
          body: ${{ steps.tag_version.outputs.changelog }}
          token: ${{ secrets.GITHUB_TOKEN }}

  # This job runs after tag-and-release and only on master branch pushes
  deploy-to-dockerhub:
    runs-on: ubuntu-latest
    needs: tag-and-release
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    steps:
      - name: Checkout
        uses: actions/checkout@v4.1.7
        
      - name: Docker Setup Buildx
        uses: docker/setup-buildx-action@v3.3.0
        
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          
      - name: Get Latest Tag
        id: get_tag
        run: |
          LATEST_TAG=$(git describe --tags --abbrev=0)
          echo "latest_tag=${LATEST_TAG}" >> $GITHUB_OUTPUT
          
      - name: Docker metadata
        id: docker_metadata
        uses: docker/metadata-action@v5
        with:
          images: ${{ vars.DOCKERHUB_USERNAME }}/minecraft-server
          tags: |
            type=raw,value=latest
            type=raw,value=${{ steps.get_tag.outputs.latest_tag }}
            
      - name: Build and push Docker images
        uses: docker/build-push-action@v6.2.0
        with:
          push: true
          context: .
          tags: ${{ steps.docker_metadata.outputs.tags }}

    