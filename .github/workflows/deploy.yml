name: Deploy Paper Server on GKE
# This workflow represents a set of basic End-to-End tests
on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
    deploy_pull:
      permissions:
        contents: 'read'
        id-token: 'write'
      runs-on: ubuntu-latest
      steps:
        - name: Checkout
          uses: actions/checkout@v4.1.2
        - name: Transform docker compose to manifest using Kompose
          id: bake
          uses: azure/k8s-bake@v3
          with:
              renderEngine: 'kompose'
              dockerComposeFile: './docker-compose.yml'
              kompose-version: 'latest'
        - name: auth GKE
          id: google_auth
          uses: 'google-github-actions/auth@v2'
          with:
            workload_identity_provider: 'projects/${{ secrets.GKE_PROJECT_ID }}/locations/global/workloadIdentityPools/${{ secrets.GKE_POOL }}/providers/${{ secrets.GKE_PROVIDER }}'
            service_account: ${{ secrets.GKE_SERVICE_ACCOUNT }}
  
        - name: 'get-credentials'
          id: gke_creds
          uses: 'google-github-actions/get-gke-credentials@v2'
          with:
            cluster_name: 'test-cluster1'
            location: 'europe-west12'