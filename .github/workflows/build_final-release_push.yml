name: Create Final Release and Push to Docker Hub
on:
  release:
    types: [published]
  workflow_dispatch:
  push:
    branches:
      - 'master'

jobs:
# This job runs when a GitHub release is published
  deploy-to-dockerhub:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4.1.7
        with:
          fetch-depth: 0  # Fetch all history and tags
        
      - name: Docker Setup Buildx
        uses: docker/setup-buildx-action@v3.3.0
        
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          
      - name: Get Release Tag
        id: get_tag
        run: |
          # Ensure we have all tags
          git fetch --tags --force
          
          if [[ "${{ github.event_name }}" == "release" ]]; then
            RELEASE_TAG=${{ github.event.release.tag_name }}
            echo "Using release tag: ${RELEASE_TAG}"
          else
            # Get the latest tag
            RELEASE_TAG=$(git tag --sort=-v:refname | head -n 1)
            echo "Found latest tag: ${RELEASE_TAG}"
            
            # If no tag exists, create a new one based on semantic versioning
            if [ -z "$RELEASE_TAG" ]; then
              echo "No existing tags found, creating initial tag"
              RELEASE_TAG="v0.1.0"
            fi
          fi
          
          echo "release_tag=${RELEASE_TAG}" >> $GITHUB_OUTPUT
          
          # Remove beta suffix if present
          FINAL_TAG=$(echo "${RELEASE_TAG}" | sed 's/-beta.*//g')
          echo "Using final tag: ${FINAL_TAG}"
          echo "final_tag=${FINAL_TAG}" >> $GITHUB_OUTPUT
          
      - name: Docker metadata
        id: docker_metadata
        uses: docker/metadata-action@v5
        with:
          images: ${{ vars.DOCKERHUB_USERNAME }}/minecraft-server
          tags: |
            type=raw,value=latest
            type=raw,value=${{ steps.get_tag.outputs.final_tag }}
            
      - name: Create GitHub Release
        if: steps.get_tag.outputs.final_tag
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ steps.get_tag.outputs.final_tag }}
          name: Release ${{ steps.get_tag.outputs.final_tag }}
          body: |
            **🎉 Hooray! A new adventure awaits! 🎉**
            
            We’re excited to announce the release of version ${{ steps.get_tag.outputs.final_tag }}!
            
            **What’s new?**
            - No changelog available
            
            **Prepare to dive into the world of creativity and fun!** 🌟
            
            Happy crafting! 🏰
            
      - name: Build and push Docker images
        uses: docker/build-push-action@v6.2.0
        with:
          push: true
          context: .
          tags: ${{ steps.docker_metadata.outputs.tags }}